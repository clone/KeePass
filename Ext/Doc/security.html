<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>
<head>
	<title>Security Information</title>
	<link rel="stylesheet" type="text/css" href="default.css" />
</head>
<body>

<table class="tablebox"><tr><td class="boxtitle">
<img src="images/menunews.gif" width="31px" height="21px" class="singleimg">
Security Information</td></tr></table>
<br />
Jump to:
<a href="#secencrypt">[Database encryption]</a> -
<a href="#sechashing">[Hashing]</a> -
<a href="#secrandom">[Random number generation]</a> -
<a href="#secbruteprotect">[Protection against dictionary attacks]</a> -
<a href="#secmemprot">[Process memory protection]</a> -
<a href="#seclocking">[Locking the workspace]</a> -
<a href="#secplugins">[Plugins]</a> -
<a href="#secselftests">[Self-tests]</a> -
<a href="#secref">[References]</a><br />
<br />
<br />
<a name="secencrypt"></a>
<b>Database encryption</b><br />
<br />
All databases are encrypted. KeePass always encrypts the whole database, i.e. not
only your passwords. Your usernames, notes, even the entry times and UUIDs, etc. are
encrypted, too.<br />
<br />
The databases are encrypted using one of the following two block ciphers:<br />
<br />
<center><table class="tablebox75">
<tr><td class="smallboxtitle"><small>Cipher</small></td>
<td class="smallboxtitle"><small>Block size</small></td>
<td class="smallboxtitle"><small>Key size</small></td></tr>

<tr><td class="boxcontent"><small>Advanced Encryption Standard (AES / Rijndael)</small></td>
<td class="boxcontent"><small>128 bits</small></td>
<td class="boxcontent"><small>256 bits</small></td></tr>

<tr><td class="boxcontent"><small>Twofish</small></td>
<td class="boxcontent"><small>128 bits</small></td>
<td class="boxcontent"><small>256 bits</small></td></tr>

</table></center>
<br />
For those who don't know: these algorithms are well-known, well-analyzed and
generally considered to be secure by the cryptographic community (see
<a href="#cryptoalg">[1]</a>
for comments by the NIST on AES for example).<br />
<br />
The block ciphers are used in the CBC (cipher-block chaining) block cipher mode.<br />
<br />
For both algorithms, a 128-bit initialization vector (IV) is generated randomly
each time you save the database.<br />
<br />
<br />
<a name="sechashing"></a>
<b>Hashing</b><br />
<br />
In order to generate the 256-bit key for the ciphers the secure hash
algorithm SHA-256 is used. Please
note that the recently discovered attack against SHA-1
<a href="#sha1break">[2]</a> doesn't affect the security
of SHA-256. SHA-256 is still considered as being secure
<a href="#sha1break2">[3]</a>.<br />
<br />
The user key (the passphrase the user enters
or the byte string in the key-file) plus an 128-bit random salt is hashed using SHA-256.
This random salt prevents attacks that are based on pre-computed hashes.<br />
<br />
When using both master key <i>and</i> key-disk together, the final key is
derived as follows: SHA-256(SHA-256(master password), key-file contents), i.e.
the hash of the master password is concatenated with the key-file bytes and
the resulting byte string is hashed with SHA-256 again. If the key-file contents
aren't exactly 32 bytes (256 bits), they are hashed with SHA-256, too, to form
a 256-bit key, i.e. the formula above changes to: SHA-256(SHA-256(master password),
SHA-256(key-file contents)).<br />
<br />
<br />
<a name="secrandom"></a>
<b>Random number generation</b><br />
<br />
We need to generate several 'random' bytes (for the IV, the master key salt,
etc.). For this,
several pseudo-random sources are used: current tick count, performance counter,
system date/time, mouse cursor position, memory status (free virtual memory,
etc.), active window, clipboard owner, various process and thread IDs, various window
focus handles (active window, desktop, ...), window message stack, process heap
status, process startup information and several system information structures.<br />
<br />
This pseudo-random data is collected in a random pool. To generate 16 random bytes,
the pool is hashed (SHA-256) with a counter to form the final 16 random bytes. The
counter is increased after 16 generated bytes, this way we can produce as many secure
random bytes as we need.<br />
<br />
<br />
<a name="secbruteprotect"></a>
<b>Protection against dictionary and guessing attacks</b><br />
<br />
KeePass offers some protection against guessing and dictionary attacks.
This is only needed when using master passwords, key-disks don't need this, they
are more secure anyway <a href="#keydisksnorounds">[4]</a>.<br />
<br />You
can't really prevent dictionary and guessing attacks, nothing prevents an attacker to just try
all possible keys and look if the database decrypts. But what we can do (and
KeePass does) is to make it harder: by adding a constant time factor to the
key initialization, we can make them as hard as we want <a href="#multihash">[5]</a>
<a href="#hardrounds">[6]</a>.<br /><br />
To generate the
'final' 256-bit key that is used for the block cipher, KeePass first hashes the
users key (SHA-256), encrypts the result <i>N</i> times using the Advanced Encryption
Standard (AES) and then hashes it again (SHA-256). Since the AES transformations
aren't pre-computable, an attacker has to perform all the encryptions, too, otherwise
he cannot try and see if the key he is currently trying is correct. The key used
for the AES transformation is randomly generated and stored in the database
header (this prevents pre-computing the AES transformations, although this
is almost impossible anyway).<br />
<br />
By default, KeePass
sets <i>N</i> to 6000 encryption 'rounds' (full encryptions are meant, has nothing
to do with the internal encryption rounds of AES). This has been done in order to
provide compatibility to the PocketPC version (PocketPC processors are slower,
therefore the key computation takes longer). Nothing prevents you from setting
this to a much larger value (you can set it in the database options dialog), if
you accept a one-second delay on your PC when opening a KeePass database, you
can even set it to a few 100.000s. Think about this: an attacker now also needs
much longer to try a key. If it takes him one second for one key, he can almost
forget any dictionary and guessing attacks.<br />
<br />
<br />
<a name="secmemprot"></a>
<b>In-memory passwords protection</b><br />
<br />
While KeePass is running, your passwords are encrypted using a <i>'session key'</i>
(randomly generated at startup).
This means, that even if you would dump the whole KeePass process memory to disk,
you couldn't find the passwords (at least not in plain text). Note that this only
applies to the passwords field, not to the usernames, etc. because of speed
reasons. When you want to copy a password to the clipboard for example, KeePass
first decrypts the password field using the session key, copies it to the clipboard
and immediately re-encrypts it using the session key. Here, ARC4 is used as encryption
algorithm, the session key has a fixed size of 12 bytes.<br />
<br />
KeePass securely erases all security-critical memory when it's not needed any more, i.e.
it overwrites those memory areas with random data before zeroing and releasing it
(this applies to all security-critical memory, not only the passwords field).<br />
<br />
<br />
<a name="seclocking"></a>
<b>Locking the workspace</b><br />
<br />
What happens when you lock the workspace? Why are you sometimes prompted to
save the database first? It's simple: locking the workspace just closes the
database completely, but remembers the last view settings (i.e. which group and entry you
selected, list position, etc.). This provides maximum security (unlocking the
workspace is as hard as opening the database the normal way) and prevents
data-loss (what if your computer crashes while the workspace is locked?).<br /><br />
<br />
<a name="secplugins"></a>
<b>Plugin security</b><br />
<br />
A separate page exists about the security of plugins:
<a href="plugins.html">Plugin Security</a>.<br />
<br />
<br />
<a name="secselftests"></a>
<b>Self-tests</b><br />
<br />
Each time you start KeePass, the program will perform a quick self-test to see
whether the block ciphers and the hash are compiled correctly and pass
their test-vectors. If one of the algorithms doesn't pass its test-vector,
KeePass will show you a security exception message box at startup.<br /><br />
<br />
<a name="secref"></a>
<hr class="separator" />
<h3>References</h3>

<a name="cryptoalg"></a>[1]
<a href="http://csrc.nist.gov/CryptoToolkit/aes/round2/r2report.pdf" target="_blank">
National Institute of Standards and Technology:
Report on the Development of the Advanced Encryption Standard (AES)</a> (PDF).<br /><br />

<a name="sha1break"></a>[2]
<a href="http://www.schneier.com/blog/archives/2005/02/sha1_broken.html" target="_blank">
Bruce Schneier's blog: SHA-1 broken</a>.<br /><br />

<a name="sha1break2"></a>[3]
<a href="http://www.schneier.com/blog/archives/2005/02/cryptanalysis_o.html" target="_blank">
Bruce Schneier's blog: Cryptanalysis of SHA-1</a>, with comments about the impact of
that discovery and what to do now.<br /><br />

<a name="keydisksnorounds"></a>[4] KeePass Open Discussion:
<a href="http://sourceforge.net/forum/forum.php?thread_id=1226921&forum_id=329220" target="_blank">
Number of encryption rounds when using key file</a>.<br /><br />

<a name="multihash"></a>[5] KeePass Open Discussion:
<a href="http://sourceforge.net/forum/forum.php?thread_id=1058950&forum_id=329220" target="_blank">
Security improvement by multiple hashing</a>.<br /><br />

<a name="hardrounds"></a>[6] KeePass Open Discussion:
<a href="http://sourceforge.net/forum/forum.php?thread_id=1201971&forum_id=329220" target="_blank">
What stops brute force attacks on KeePass?</a>.<br /><br />

</body>
</html>
